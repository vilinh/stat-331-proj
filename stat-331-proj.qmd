---
title: "Final Project"
subtitle: "Project Proposal"
author: "Alex Sullivan, Megan Kerner, Isabelle Phraner, Vi-Linh Vu"
format: 
  html:
    embed-resources: true
    code-tools: true
    toc: true
editor: source
execute: 
  error: true
  echo: true
  message: false
  warning: false
code-fold: true
self-contained: true
number-sections: true
---

## Project Proposal - Data {.unnumbered}

### Reading in Data {.unnumbered}

```{r}
# | code-fold: true
library(tidyverse)
library(here)
library(broom)
library(purrr)
library(knitr)

child_mortality <- read_csv("child_mortality_0_5_year_olds_dying_per_1000_born.csv")
GDP_per_Cap <- read_csv("gdp_pcap.csv")
```

## Data Description and Cleaning Process

Our analysis explores the relationship between child mortality and GDP per capita across various countries over time. We utilize two primary datasets:

1.  **Child Mortality Dataset**: Combines data from multiple sources including Gapminder (v7) for years 1800 to 1950, UNIGME (a collaboration among UNICEF, WHO, the UN Population Division, and the World Bank) for years 1950 to 2016, and UN POP (World Population Prospects 2019) for projections up to 2100.

2.  **GDP per Capita Dataset**: Aggregates GDP per capita data from the World Bank, the Maddison Project Database, and the Penn World Table, offering a comprehensive view of economic performance across nations over time.

To ensure the relevance and accuracy of our analysis, we confined our examination to the period between the 1950s and 2020. A few factors motivated this decision. First, due to timelines of independence and colonial rule, many of the countries in the dataset did not formally exist until the 1950s or 1960s, and were instead territories of world powers such as England. Second, by refining our time frame, we are able to analyze historical trends without projected data beyond 2020 skewing our results. Having more consistent data also allows us to minimize the impact of NA values.

To enhance our datasets, we pivoted the structure into a long format. This allowed us to create a dataset where each row represents a unique year-country pair, detailing both the mortality rate and GDP per capita for that entry. This pivot from a wide to a long format facilitates better comparative and temporal analysis, ensuring a coherent dataset more in line with our study's objectives.

Recognizing the importance of data uniformity and precision, we also converted all quantitative values to numeric formats. One challenge was encountered was that within the GDP per capita data, values denoted with a "k" needed conversion to their full numeric equivalents. This step was crucial in maintaining the accuracy and consistency of our data, allowing for reliable quantitative analysis.

After individually refining the child mortality and GDP per capita datasets, we merged them based on country and year to get one comprehensive dataset that integrates child mortality rates with GDP per capita, alongside the corresponding year and country for each data point. Our final dataset covers 195 countries over a span of 71 years from 1950 to 2020. This extensive coverage enables us to conduct a thorough examination of the dynamics between economic indicators and health outcomes on a global scale.

------------------------------------------------------------------------

```{r}
# | code-fold: true
# Refine child_mortality dataset
child_mortality <- child_mortality |>
  select(country, `1950`:`2020`)

# Refine GDP_per_Capita dataset
GDP_per_Cap <- GDP_per_Cap |>
  select(country, `1950`:`2020`)
```

```{r}
# | code-fold: true
child_mortality_long <- child_mortality |>
  pivot_longer(
    cols = !country,
    names_to = "Year",
    values_to = "Mortality Rate"
  )

GDP_per_Cap_long <- GDP_per_Cap |>
  pivot_longer(
    cols = !country,
    names_to = "Year",
    values_to = "GDP Per Capita"
  )

```

```{r}
# | code-fold: true
# function converts numbers in "XXk" format to numeric
# eg "89k" -> 89,000
convert_k_to_number <- function(x) {
  if (grepl("k", x, fixed = TRUE)) {
    numeric_value <- as.numeric(sub("k", "", x)) * 1000
  } else {
    numeric_value <- as.numeric(x)
  }
  return(numeric_value)
}
```

```{r}
# | code-fold: true
# converts mortality rate to numeric
child_mortality_long <- child_mortality_long |>
  filter(!is.na(child_mortality_long$`Mortality Rate`)) |>
  mutate(`Mortality Rate` = as.numeric(`Mortality Rate`))

# converts gdp to numeric
GDP_per_Cap_long <- GDP_per_Cap_long |>
  mutate(`GDP Per Capita` = sapply(`GDP Per Capita`, convert_k_to_number))
```

```{r}
# | code-fold: true
joined_df <- inner_join(child_mortality_long, GDP_per_Cap_long, join_by(country, Year)) |>
  mutate(Year = as.numeric(Year))
```

## Variable Description and Hypothesized Relationship

We decided to limit our examination to the 1950s-2020 because some countries did not exist then, and therefore that took care of a lot of the NA values. The dataset also has years \> 2020, but we wanted to look at how the past data points changed over time without the predicted values. We pivoted the data to be longer so it can be easily analyzed (on mortality rate and GDP per capita for each year). Then, we converted the values to be numeric as they represent quantitative data. For the GDP, we had to convert some values that had a "k" in it to the actual multiple of 1000. The final dataset has 195 different countries, spanning across 71 years.

### Variable Description

The first variable in our joined data set is "country", which specifies the country that the following data describes. The next variable is "Year", which specifies the year in which the following data was collected. In our data, we limited our "Year" variable from 1950-present because many countries did not exist and therefore had missing data prior to then. The "Mortality Rate" variable represents the number of deaths of children under 5 years old per 1000 live births. Finally, the "GDP Per Capita" variable represents the gross domestic product per person. The data for "GDP Per Capita" was also adjusted for differences in purchasing power.

differences in purchasing power. According to the International Monetary Fund, GDP is a monetary measure of the market value of all the final goods and services produced in a specific time period by a country or countries. [GDP](https://www.imf.org/en/Publications/fandd/issues/Series/Back-to-Basics/gross-domestic-product-GDP) is often used by the government of a single country to measure its economic health.

Our analysis revolves around four primary variables within the merged dataset:

-   **Country**: This categorical variable identifies the nation to which the subsequent data points pertain. The inclusion of this variable allows for country-specific analyses, acknowledging the geopolitical diversity and its potential impact on health and economic indicators.

-   **Year**: Ranging from 1950 to 2020, this numeric variable indicates the year of data collection. The decision to restrict our analysis to this period accounts for the emergence of new sovereign states and the availability of consistent data.

### Hypothesized Relationship

-   **Mortality Rate (per 1,000 live births)**: Representing the probability of dying between birth and the age of five, this variable is an indicator of child health and overall societal well-being. It's derived from a combination of sources, including the United Nations Inter-agency Group for Child Mortality Estimation (UN IGME) and the World Population Prospects.

-   **GDP Per Capita (PPP-adjusted)**: This economic metric reflects the gross domestic product divided by midyear population, adjusted for purchasing power parity. It serves as a measure of a country's economic performance and living standards, which allows for comparison across different cost-of-living and inflation scenarios. GDP per capita is instrumental in assessing the economic capacity and resource availability that can influence public health infrastructure, access to healthcare, and overall quality of life.

Our hypothesis predicts a negative correlation between GDP per capita and child mortality rates, based on the ssumption that higher economic status, as indicated by GDP per capita, is associated with enhanced access to healthcare, improved living conditions, and higher investment in public health infrastructure. These conditions are expected to contribute to lower child mortality rates, reflecting better health outcomes in economically prosperous countries.

Moreover, we expect a significant temporal decrease in child mortality rates, echoing global health advancements and the intensification of international efforts to combat child mortality. This expectation is supported by historical data, including reports from the World Health Organization, which indicate a decline of over 59% in child mortality rates since 1990. Such trends underscore the impact of both economic development and targeted health interventions in improving child survival rates.

Our analysis seeks to quantify these relationships, offering insights into the dynamics between economic growth and health outcomes, with a particular focus on the well-being of the youngest members of societies across the globe.

## Linear Regression

In our study, we employ linear regression to examine the potential impact of GDP per capita on child mortality rates. Linear regression is an appropriate statistical method for this analysis as it allows us to model the relationship between a continuous response variable and one or more explanatory variables. We hypothesize that GDP per capita (explanatory variable, x) inversely affects the child mortality rate (response variable, y\^â€‹), with the expectation that higher GDP per capita is associated with lower child mortality rates. in order to esatblish whether linear regression was appropriate, we revisited our LINE assumptions:

We made two graphs to examine and visualize the relationship between GDP per Capita and Child Mortality Rate. We want to see how GDP per Capita (the explanatory variable) potentially affects the Child Mortality Rate (the response variable).

-   **Linearity**: The relationship between GDP per capita and child mortality rate appears linear

<!-- -->

-   **Independence**: Observations are independent of each other

-   **Normality**: The residuals of the model are normally distributed

-   **Equal Variance**: The variance of the error terms is constant across values of GDP per capita

As a preliminary check, we created two scatterplots to visually assess the relationship between GDP per capita and the Child Mortality Rate over time. Our aim was to discern the form, direction, strength, and presence of any unusual observations in the relationship between these two variables.\

```{r}
# | code-fold: true
year_avgs <- joined_df |>
  group_by(country) |>
  summarise(
    Avg_Mortality_Rate = mean(`Mortality Rate`, na.rm = TRUE),
    Avg_GDP_Per_Capita = mean(`GDP Per Capita`, na.rm = TRUE)
  )
```

#### Overall Relationship between GDP and Child Mortality

```{r}
# | code-fold: true
year_avgs |>
  ggplot(aes(x = Avg_GDP_Per_Capita, y = Avg_Mortality_Rate)) +
  geom_point(alpha = 0.5, color = 'blue') +
  theme_minimal() +
  labs(x = "Average GDP Per Capita", y = "Average Mortality Rate",
       title = "Average Mortality Rate vs Average GDP Per Capita by Country")
```

The scatterplot of average GDP per capita against average mortality rate shows a general downward trend, suggesting a negative correlation where higher GDP per capita is associated with lower child mortality rates. The relationship exhibits a non-linear form, with the strength of the relationship varying across the range of GDP values. Notably, some countries with similar GDP per capita exhibit a wide range of mortality rates, indicating other factors may influence mortality beyond GDP alone.

#### Relationship between GDP and Child Mortality Over Time

```{r}
# | code-fold: true
joined_df |>
  mutate(Decade = floor(Year / 10) * 10) |>
  ggplot(aes(x = `GDP Per Capita`, y = `Mortality Rate`)) +
  geom_point(alpha = 0.25, color = 'purple') +
  facet_wrap(~ Decade, scales = "free") +
  labs(title = "GDP Per Capita vs Child Mortality Rate Over Time",
       x = "GDP Per Capita",
       y = "Mortality Rate") +
  theme_minimal()
```

The first graph plots the GDP per capita per against the child mortality rate and is faceted by decade in order to see how the relationship between the two variables change over time. At a glance, it does not appear that the relationship between the two variables change drastically over the decades as all of the grids have a similar concave shape. While the overall shape of the relationship between the variables is similar across decades, it's notable that the actual numerical values do vary over time, as indicated by the differing scales on each graph.

The second graph plots the GDP per capita per against the child mortality rate and is faceted by decade in order to see how the relationship between the two variables change over time. At a glance, it does not appear that the relationship between the two variables change drastically over the decades as all of the grids have a similar concave shape. While the overall shape of the relationship between the variables is similar across decades, it's evident that the actual numerical values do vary over time, as indicated by the differing scales on each graph.

### Linear Regression

Here, we create a linear model where the response variable is the child mortality rate and the explanatory variable is the GDP per capita. We want to see how child mortality is affected by changes in GDP.

Here, we create a linear regression model where the response variable is the child mortality rate and the explanatory variable is the GDP per capita. We want to see how child mortality is affected by changes in GDP, according to linear regression.

Our linear model is represented by the equation $$\hat{y} = 128 - 0.00254x$$ where $\hat{y}$ represents the predicted child mortality rate, $x$ represents represents the GDP per capita, $B0$ (intercept) indicates the child mortality rate when GDP per capita is zero, and $B1$ (slope) represents the change in child mortality rate for a one-unit increase in GDP per capita. 
```{r}
# | code-fold: true
mortalitygdp_lm <- lm(Avg_Mortality_Rate ~ Avg_GDP_Per_Capita,
  data = year_avgs)

tidy(mortalitygdp_lm)
```

$$\hat{y} = 128 - 0.00254x$$

### Model Fit

Based on the results of our linear model, we find that child deaths when GDP is zero are 128.4. We round this to \~128 deaths, as there cannot be fractions of a death. Because is it highly unlikely for the true GDP to ever be zero, this intercept is somewhat irrelevant. We also find that, holding other factors constant, a one-unit (\$1000 USD) increase in GDP corresponds to the child mortality rate decreasing -0.0025 on average. It's important to note that the interpretation of the slope coefficient involves units from both variables, confirming the validity of using different scales in our analysis.

### Model Fit

```{r}
# | code-fold: true
aug <- broom::augment(mortalitygdp_lm)
variance_table <- data.frame(
  Variable = c("Response Values", "Fitted Values", "Residuals"),
  Variance = c(var(aug$Avg_Mortality_Rate), 
               var(aug$.fitted), 
               var(aug$.resid))
)
kable(variance_table, caption = "Variance Table") 
```

The variance table derived from our model's residuals allows us to calculate the R-squared using the formula $R^2 = \frac{{\text{var}( \hat{y})}}{{\text{var}(y)}}$, with $\hat{y}$ being the variance of the fitted values and $y$ being the variance of the response values. Plugging these values into our formula, we get an $R^2$ value of approximately 0.3258. This indicates that approximately 32.58% of the variance in child mortality rates is explained by GDP per capita. While this suggests a significant relationship, it also highlights the presence of other factors affecting child mortality that are not captured by GDP per capita alone. The measurement of child mortality rates was based on the probability of dying between birth and age 5 per 1,000 live births, providing a standardized metric for international health comparisons.

## Simulation

### Visualizing Simulations from the Model

```{r}
# 1. generate predictions using  predict() 
predictions <- predict(mortalitygdp_lm, newdata = year_avgs)

# 2. add random errors to the predictions w/ residual standard error (acquired with sigma())
std_error <- sigma(mortalitygdp_lm)
simulated_errors <- rnorm(n = length(predictions), mean = 0, sd = std_error)

# 3. plotting doom

simulated_year_avgs <- year_avgs|>
    mutate(Simulated_Mortality = predictions + simulated_errors)


# obs
observed_plot <- ggplot(year_avgs, aes(x = Avg_GDP_Per_Capita, y = Avg_Mortality_Rate)) +
  geom_point(aes(color = "Observed"), alpha = 0.6) +
  geom_smooth(method = "lm", se = FALSE, color = "blue", linetype = "dashed") +
  theme_minimal() +
  labs(title = "Observed Average Mortality Rate vs. Average GDP Per Capita",
       color = "Data Type")


# sim

simulated_plot <- ggplot(simulated_year_avgs, aes(x = Avg_GDP_Per_Capita, y = Simulated_Mortality)) +
  geom_point(aes(color = "Simulated"), alpha = 0.6) +
  geom_smooth(method = "lm", se = FALSE, color = "red", linetype = "dashed") +
  theme_minimal() +
  labs(title = "Simulated Average Mortality Rate vs. Average GDP Per Capita",
       color = "Data Type")


library(patchwork)

(observed_plot | simulated_plot) + 
  patchwork::plot_layout(guides = 'collect') & 
  theme(legend.position = 'bottom')

# need to fix labels, maybe add another mutate column
  
```

### Generating Multiple Predictive Checks

```{r}

sd <- sigma(mortalitygdp_lm)
noise <- function(x, mean = 0, sd){
  x + rnorm(length(x), 
            mean, 
            sd)
}

nsims <- 1000
sims <- map_dfc(.x = 1:nsims,
                .f = ~ tibble(sim = noise(predictions, 
                                          sd = sd)
                              ))
colnames(sims) <- colnames(sims) |> 
  str_replace(pattern = "\\.\\.\\.",
                  replace = "_")

sims <- year_avgs |> 
  filter(!is.na(`Avg_Mortality_Rate`)) |> 
  select(`Avg_GDP_Per_Capita`)|> 
  bind_cols(sims)

sim_r_sq <- sims |> 
  map(~ lm(Avg_GDP_Per_Capita ~ .x, data = sims)) |> 
  map(glance) |> 
  map_dbl(~ .x$r.squared)


tibble(sims = sim_r_sq) |> 
  ggplot(aes(x = sims)) + 
  geom_histogram(binwidth = 0.025) +
  labs(x = expression("Simulated"~ R^2),
       y = "",
       subtitle = "Number of Simulated Models") +
  theme_bw()




```


```{r}

tibble(sims = sim_r_sq)

```



